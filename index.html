<!DOCTYPE html>
<html lang="bs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=1200, user-scalable=yes">
<title>Pogon Gospodarenja â€“ Dispozicije | Bos. Krupa</title>

<!-- Firebase SDK -->
<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
import {
  getFirestore,
  collection,
  doc,
  getDocs,
  setDoc,
  deleteDoc,
  onSnapshot,
  writeBatch,
  query,
  orderBy
} from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

const firebaseConfig = {
  apiKey: "AIzaSyDqA6mIrhoC9m6QkO13pEU7rPVHWz6evTc",
  authDomain: "dispozicije-krupa.firebaseapp.com",
  projectId: "dispozicije-krupa",
  storageBucket: "dispozicije-krupa.firebasestorage.app",
  messagingSenderId: "584482793304",
  appId: "1:584482793304:web:8b05fb6c645909d2f0672d",
  measurementId: "G-9LDVCWQYVJ"
};

const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);

// expose everything to global scope so regular <script> can use it
window._db = db;
window._fb = {
  collection,
  doc,
  getDocs,
  setDoc,
  deleteDoc,
  onSnapshot,
  writeBatch,
  query,
  orderBy
};
window._firebaseReady = true;
window.dispatchEvent(new Event('firebaseReady'));
</script>

<style>
@import url('https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=Syne:wght@400;600;700;800&display=swap');
:root{
  --bg:#0f1117;--surface:#181c25;--surface2:#1e2330;--border:#2a3040;
  --accent:#c8a85a;--green:#6fba8a;--red:#e05a5a;--text:#dde3ee;--muted:#6b7590;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{background:var(--bg);color:var(--text);font-family:'DM Mono',monospace;font-size:15px;min-height:100vh;}

/* â”€â”€ LOADER â”€â”€ */
#loader{position:fixed;inset:0;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:999;gap:16px;}
#loader h2{font-family:'Syne',sans-serif;font-size:22px;color:var(--accent);}
#loader p{font-size:13px;color:var(--muted);}
.big-spinner{width:48px;height:48px;border:4px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}

/* â”€â”€ HEADER â”€â”€ */
header{background:var(--surface);border-bottom:1px solid var(--border);padding:16px 28px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;}
header h1{font-family:'Syne',sans-serif;font-size:22px;font-weight:800;letter-spacing:.04em;color:var(--accent);}
header .sub{font-size:12px;color:var(--muted);margin-top:2px;}
.header-right{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
.date-badge{background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:6px 14px;font-size:13px;color:var(--accent);}
.online-dot{width:8px;height:8px;border-radius:50%;background:var(--green);box-shadow:0 0 6px var(--green);display:inline-block;margin-right:4px;}
.sync-btn{display:inline-flex;align-items:center;gap:6px;padding:8px 18px;border-radius:6px;border:1px solid var(--border);background:var(--surface2);color:var(--text);font-family:'Syne',sans-serif;font-size:13px;font-weight:700;cursor:pointer;transition:all .15s;}
.sync-btn:hover{border-color:var(--accent);color:var(--accent);}
.sync-btn.loading{opacity:.6;pointer-events:none;}
.sync-status{font-size:12px;color:var(--muted);}

/* â”€â”€ LAYOUT â”€â”€ */
main{padding:20px 28px;max-width:1700px;}
.tabs{display:flex;gap:4px;margin-bottom:20px;border-bottom:1px solid var(--border);}
.tab{padding:11px 22px;background:none;border:none;color:var(--muted);font-family:'Syne',sans-serif;font-size:14px;font-weight:600;cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-1px;transition:all .15s;}
.tab.active{color:var(--accent);border-bottom-color:var(--accent);}
.tab:hover:not(.active){color:var(--text);}
.panel{display:none;}.panel.active{display:block;}

/* â”€â”€ TABLE â”€â”€ */
.table-wrap{overflow-x:auto;border:1px solid var(--border);border-radius:10px;}
table{width:100%;border-collapse:collapse;font-size:14px;}
thead{background:var(--surface2);position:sticky;top:0;z-index:2;}
thead tr:first-child th{font-family:'Syne',sans-serif;font-size:11px;font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:var(--accent);padding:10px 8px 4px;border-bottom:1px solid var(--border);text-align:center;}
thead tr:last-child th{font-size:12px;color:var(--muted);padding:4px 8px 10px;text-align:center;border-bottom:2px solid var(--border);}
tbody tr{border-bottom:1px solid var(--border);transition:background .1s;}
tbody tr:hover{background:var(--surface2);}
tbody tr:nth-child(even){background:rgba(255,255,255,.012);}
td{padding:8px 8px;text-align:center;color:var(--muted);white-space:nowrap;}
td.kupac{text-align:left;font-family:'Syne',sans-serif;font-weight:700;font-size:14px;color:var(--text);min-width:150px;}
td.pos{color:var(--green);font-weight:600;}
td.neg{color:var(--red);font-weight:600;}
td.warn{color:var(--accent);font-weight:600;}

/* â”€â”€ CHIPS / BADGES â”€â”€ */
.bal-chip{display:inline-flex;align-items:center;gap:3px;padding:2px 8px;border-radius:10px;font-size:11px;font-weight:600;}
.bal-ok{background:#1a2e22;color:var(--green);border:1px solid #3a6b4a;}
.bal-warn{background:#2e2a1a;color:var(--accent);border:1px solid #6b5a3a;}
.bal-neg{background:#2e1a1a;color:var(--red);border:1px solid #6b3a3a;}
.badge{display:inline-flex;align-items:center;gap:4px;background:var(--surface2);border:1px solid var(--border);border-radius:4px;padding:3px 9px;font-size:11px;color:var(--accent);font-weight:600;margin:2px 2px 2px 0;}
.badge.green{background:#1a2e22;border-color:#3a6b4a;color:var(--green);}
.badge.blue{background:#1a2038;border-color:#3a4a8a;color:#7a9af0;}
.badge.red{background:#2e1a1a;border-color:#6b3a3a;color:var(--red);}

/* â”€â”€ PROGRESS â”€â”€ */
.prog-wrap{background:var(--border);border-radius:4px;height:5px;margin-top:5px;overflow:hidden;}
.prog-bar{height:100%;border-radius:4px;transition:width .4s;}
.prog-ok{background:var(--green);}.prog-warn{background:var(--accent);}.prog-neg{background:var(--red);}

/* â”€â”€ STATUS BAR â”€â”€ */
.status-bar{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:14px 20px;display:flex;gap:28px;margin-bottom:18px;flex-wrap:wrap;align-items:center;}
.stat{display:flex;flex-direction:column;gap:3px;}
.stat .sl{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;}
.stat .sv{font-family:'Syne',sans-serif;font-size:20px;font-weight:800;}
.sv.green{color:var(--green);}.sv.yellow{color:var(--accent);}.sv.red{color:var(--red);}
.divider{width:1px;background:var(--border);align-self:stretch;}

/* â”€â”€ FORMS â”€â”€ */
.form-section{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:24px;margin-bottom:20px;}
.form-section h2{font-family:'Syne',sans-serif;font-size:17px;font-weight:700;color:var(--accent);margin-bottom:18px;padding-bottom:10px;border-bottom:1px solid var(--border);}
.form-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px;}
.form-group{display:flex;flex-direction:column;gap:5px;}
.form-group label{font-size:11px;letter-spacing:.08em;text-transform:uppercase;color:var(--muted);}
.form-group input,.form-group select{background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:9px 12px;color:var(--text);font-family:'DM Mono',monospace;font-size:14px;outline:none;transition:border-color .15s;}
.form-group input:focus,.form-group select:focus{border-color:var(--accent);}
.form-group select option{background:var(--surface2);}
.section-label{font-size:12px;letter-spacing:.1em;text-transform:uppercase;color:var(--accent);margin:14px 0 8px;padding-bottom:5px;border-bottom:1px solid var(--border);}
.form-actions{margin-top:18px;display:flex;gap:10px;flex-wrap:wrap;}

/* â”€â”€ BUTTONS â”€â”€ */
.btn{display:inline-flex;align-items:center;gap:6px;padding:10px 20px;border-radius:6px;border:none;cursor:pointer;font-family:'Syne',sans-serif;font-size:14px;font-weight:700;letter-spacing:.05em;transition:all .15s;}
.btn-primary{background:var(--accent);color:#111;}.btn-primary:hover{background:#d9b96a;}
.btn-success{background:var(--green);color:#111;}.btn-success:hover{background:#85cc9e;}
.btn-danger{background:var(--red);color:#fff;}.btn-danger:hover{background:#ee7070;}
.btn-ghost{background:var(--surface2);border:1px solid var(--border);color:var(--text);}
.btn-ghost:hover{border-color:var(--accent);color:var(--accent);}

/* â”€â”€ SEARCH â”€â”€ */
.search-bar{display:flex;align-items:center;gap:10px;margin-bottom:14px;flex-wrap:wrap;}
.search-bar input{background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:9px 16px;color:var(--text);font-family:'DM Mono',monospace;font-size:14px;outline:none;width:280px;}
.search-bar input:focus{border-color:var(--accent);}
.search-bar label{display:flex;align-items:center;gap:6px;font-size:13px;color:var(--muted);cursor:pointer;}

/* â”€â”€ AVAIL GRID â”€â”€ */
.avail-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:10px;margin:10px 0;}
.avail-item{background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:10px 12px;}
.avail-item .al{font-size:11px;color:var(--muted);text-transform:uppercase;}
.avail-item .av{font-size:18px;font-weight:700;margin-top:3px;}
.avail-item .ao{font-size:11px;color:var(--muted);}

/* â”€â”€ MODAL â”€â”€ */
.modal-bg{display:none;position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:200;align-items:center;justify-content:center;}
.modal-bg.open{display:flex;}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:28px;width:92%;max-width:600px;max-height:90vh;overflow-y:auto;}
.modal h3{font-family:'Syne',sans-serif;font-size:18px;font-weight:800;color:var(--accent);margin-bottom:18px;}

/* â”€â”€ HISTORIJA CARD â”€â”€ */
.otprema-card{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:16px 20px;display:flex;align-items:flex-start;gap:18px;flex-wrap:wrap;margin-bottom:8px;}
.val-item{display:flex;flex-direction:column;gap:2px;}
.val-item .vl{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;}
.val-item .vv{font-size:15px;color:var(--text);font-weight:500;}

/* â”€â”€ MISC â”€â”€ */
.empty-state{text-align:center;padding:50px 20px;color:var(--muted);}
.empty-state .big{font-size:40px;margin-bottom:8px;}
.empty-state p{font-family:'Syne',sans-serif;font-size:14px;}
.del-disp-btn{background:none;border:none;color:var(--muted);cursor:pointer;font-size:14px;padding:3px 8px;border-radius:4px;transition:all .1s;}
.del-disp-btn:hover{color:var(--red);}
.edit-disp-btn{background:none;border:1px solid var(--border);color:var(--muted);cursor:pointer;font-size:12px;padding:3px 9px;border-radius:4px;transition:all .1s;font-family:'Syne',sans-serif;font-weight:600;}
.edit-disp-btn:hover{border-color:var(--accent);color:var(--accent);}
.spinner-sm{display:inline-block;width:13px;height:13px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .7s linear infinite;}
.toast{position:fixed;bottom:24px;right:24px;background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:14px 20px;font-size:14px;z-index:999;transform:translateY(60px);opacity:0;transition:all .3s;}
.toast.show{transform:translateY(0);opacity:1;}
.toast.success{border-color:var(--green);color:var(--green);}
.toast.error{border-color:var(--red);color:var(--red);}
.realtime-pulse{width:8px;height:8px;border-radius:50%;background:var(--green);display:inline-block;animation:pulse 2s infinite;}
@keyframes pulse{0%,100%{opacity:1;}50%{opacity:.3;}}
.total-row td{background:var(--surface2);font-weight:700;border-top:2px solid var(--border);}
.sortable{cursor:pointer;user-select:none;transition:color .15s;}
.sortable:hover{color:var(--accent)!important;}
.sortable.sort-asc::after{content:' â–²';font-size:10px;opacity:.8;}
.sortable.sort-desc::after{content:' â–¼';font-size:10px;opacity:.8;}

/* â”€â”€ MOBILE CARDS â”€â”€ */
.mob-list{display:none;}
.mob-card{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:14px 16px;margin-bottom:10px;}
.mob-head{display:flex;justify-content:space-between;align-items:baseline;margin-bottom:5px;}
.mob-kupac{font-family:'Syne',sans-serif;font-weight:800;font-size:15px;color:var(--text);}
.mob-meta{font-size:12px;color:var(--muted);display:flex;gap:10px;flex-wrap:wrap;margin-bottom:9px;}
.mob-vals{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:10px;}
.mob-val{background:var(--surface2);border-radius:6px;padding:7px 10px;}
.mob-val .mvl{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;}
.mob-val .mvv{font-size:16px;font-weight:700;margin-top:2px;}
.mob-foot{display:flex;align-items:center;gap:8px;flex-wrap:wrap;}
.mob-acts{margin-left:auto;display:flex;gap:6px;}

/* Desktop toggle (hidden on desktop, shown on mobile via media query) */
#desktopToggleWrap{display:none;}

/* â”€â”€ MOBILE BOTTOM NAV â”€â”€ */
.mobile-nav{display:none;}

/* â•â• RESPONSIVE â•â• */
@media (max-width: 767px) {
  /* Header */
  header{padding:10px 14px;gap:8px;}
  header h1{font-size:15px;}
  header .sub{display:none;}
  .sync-btn{padding:7px 11px;font-size:12px;}
  .date-badge{font-size:12px;padding:5px 9px;}
  .sync-status{display:none;}

  /* Main layout */
  main{padding:12px 12px 78px;}

  /* Hide desktop tabs, show mobile nav */
  .tabs{display:none;}
  .mobile-nav{
    display:flex;position:fixed;bottom:0;left:0;right:0;
    background:var(--surface);border-top:2px solid var(--border);
    z-index:100;height:62px;
  }
  .mnav-btn{
    flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;
    gap:2px;background:none;border:none;color:var(--muted);cursor:pointer;
    font-family:'Syne',sans-serif;padding:5px 2px;transition:color .15s;
  }
  .mnav-btn .mni{font-size:20px;line-height:1;}
  .mnav-btn .mnl{font-size:9px;font-weight:700;letter-spacing:.04em;text-transform:uppercase;}
  .mnav-btn.active{color:var(--accent);}
  .mnav-btn.active .mni{filter:drop-shadow(0 0 4px var(--accent));}

  /* Status bar */
  .status-bar{gap:10px;padding:10px 12px;overflow-x:auto;flex-wrap:nowrap;}
  .stat .sv{font-size:17px;}
  .divider{display:none;}

  /* Default mobile: desktop table (scrollable), cards skrivene */
  .table-wrap{overflow-x:auto;display:block;}
  .mob-list{display:none;}
  /* Kad korisnik prebaci na cards mode */
  body.mob-cards-mode .table-wrap{display:none;}
  body.mob-cards-mode .mob-list{display:block;}

  /* Desktop toggle - vidljiv samo na mobilnom */
  #desktopToggleWrap{display:flex;}

  /* Search bar */
  .search-bar{flex-direction:column;align-items:stretch;gap:8px;}
  .search-bar input{width:100%;}
  .search-bar .btn{width:100%;}

  /* Modals: bottom sheet */
  .modal-bg{align-items:flex-end;}
  .modal{width:100%!important;max-width:100%!important;border-radius:16px 16px 0 0;max-height:92vh;padding:20px 16px 28px;}
  .modal h3{font-size:16px;}

  /* Forms */
  .form-section{padding:14px;}
  .form-grid{grid-template-columns:1fr!important;}
  .form-group[style*="span 2"]{grid-column:span 1!important;}

  /* Toast above nav */
  .toast{left:12px;right:12px;bottom:70px;}

  /* Historija cards */
  .otprema-card{padding:12px 14px;gap:10px;}
}
</style>
</head>
<body>

<!-- LOADER -->
<div id="loader">
  <div class="big-spinner"></div>
  <h2>ğŸŒ² Pogon Gospodarenja</h2>
  <p id="loaderMsg">Spajanje na Firebase...</p>
</div>

<header style="display:none" id="mainHeader">
  <div>
    <h1>ğŸŒ² POGON GOSPODARENJA â€“ BOS. KRUPA</h1>
    <div class="sub">
      <span class="realtime-pulse"></span>
      Realtime baza Â· svi korisnici vide iste podatke Â· automatska sinkronizacija otprema
    </div>
  </div>
  <div class="header-right">
    <div id="syncStatus" class="sync-status">â€”</div>
    <button class="sync-btn" id="syncBtn" onclick="syncSheet()">
      <span class="spinner-sm" id="syncSpinner" style="display:none"></span>
      ğŸ”„ Dodaj otpremu
    </button>
    <div class="date-badge" id="dateBadge"></div>
  </div>
</header>

<main style="display:none" id="mainContent">
  <div class="tabs">
    <button class="tab active" onclick="switchTab('pregled')">ğŸ“‹ Dispozicije</button>
    <button class="tab" onclick="switchTab('nova')">â• Nova dispozicija</button>
    <button class="tab" onclick="switchTab('otprema')">ğŸš› RuÄna otprema</button>
    <button class="tab" onclick="switchTab('historija')">ğŸ“œ Historija otprema</button>
  </div>

  <!-- PREGLED -->
  <div id="tab-pregled" class="panel active">
    <div class="status-bar" id="statusBar"></div>
    <div class="search-bar">
      <input type="text" id="searchInput" placeholder="PretraÅ¾i po kupcu ili ugovoru..." oninput="renderPregled()">
      <button class="btn btn-ghost" onclick="exportCSV()">â¬‡ Export CSV</button>
      <label><input type="checkbox" id="showZero" onchange="renderPregled()"> PrikaÅ¾i iscrpljene</label>
      <label id="desktopToggleWrap"><input type="checkbox" id="desktopToggle" checked onchange="toggleDesktopView(this.checked)"> ğŸ–¥ Desktop</label>
    </div>
    <div id="pregledNaslov" style="font-size:17px;font-weight:700;text-align:center;padding:14px 0 6px;letter-spacing:1.5px;color:var(--text);text-transform:uppercase"></div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th colspan="4"></th>
            <th colspan="4" style="border-left:2px solid var(--border)">ÄŒETINARI</th>
            <th colspan="4" style="border-left:2px solid var(--border)">LIÅ Ä†ARI</th>
            <th colspan="2"></th>
          </tr>
          <tr>
            <th class="sortable" id="th-kupac" onclick="sortBy('kupac')">KUPAC</th><th>BROJ</th><th>DATUM</th><th>UGOVOR</th>
            <th class="sortable" id="th-tc" style="border-left:2px solid var(--border)" onclick="sortBy('tc')">Trupci ÄŒ</th>
            <th class="sortable" id="th-rud" onclick="sortBy('rud')">Rudno</th>
            <th class="sortable" id="th-cd" onclick="sortBy('cd')">Cel.Duga</th>
            <th class="sortable" id="th-cc" onclick="sortBy('cc')">Cel.Cij.</th>
            <th class="sortable" id="th-tl" style="border-left:2px solid var(--border)" onclick="sortBy('tl')">Trupci L</th>
            <th class="sortable" id="th-fl" onclick="sortBy('fl')">F/L</th>
            <th class="sortable" id="th-oc" onclick="sortBy('oc')">Ogr.Cij.</th>
            <th class="sortable" id="th-od" onclick="sortBy('od')">Ogr.Dugi</th>
            <th>STATUS</th><th></th>
          </tr>
        </thead>
        <tbody id="pregledBody"></tbody>
      </table>
    </div>
    <!-- Mobile card list (visible only on mobile) -->
    <div id="mob-list" class="mob-list"></div>
  </div>

  <!-- NOVA DISPOZICIJA -->
  <div id="tab-nova" class="panel">
    <div class="form-section">
      <h2>â• Nova dispozicija / avansna uplata</h2>
      <div class="form-grid">
        <div class="form-group" style="grid-column:span 2">
          <label>Kupac *</label>
          <select id="n_kupac"><option value="">â€” Odaberi kupca â€”</option></select>
        </div>
        <div class="form-group">
          <label>Broj dispozicije *</label>
          <input type="text" id="n_broj" placeholder="npr. 131/26-T">
        </div>
        <div class="form-group">
          <label>Datum</label>
          <input type="date" id="n_datum">
        </div>
        <div class="form-group" style="grid-column:span 2">
          <label>Ugovor</label>
          <input type="text" id="n_ugovor" placeholder="npr. 01-94-1/26">
        </div>
      </div>
      <div class="section-label">ğŸŒ² ÄŒETINARI</div>
      <div class="form-grid">
        <div class="form-group"><label>Trupci I-III (mÂ³)</label><input type="number" id="n_tc" step="0.01" placeholder="0.00"></div>
        <div class="form-group"><label>Rudno / RD (mÂ³)</label><input type="number" id="n_rud" step="0.01" placeholder="0.00"></div>
        <div class="form-group"><label>Cel. Duga (mÂ³)</label><input type="number" id="n_cd" step="0.01" placeholder="0.00"></div>
        <div class="form-group"><label>Cel. Cijepana (mÂ³)</label><input type="number" id="n_cc" step="0.01" placeholder="0.00"></div>
      </div>
      <div class="section-label">ğŸ‚ LIÅ Ä†ARI</div>
      <div class="form-grid">
        <div class="form-group"><label>Trupci I-III (mÂ³)</label><input type="number" id="n_tl" step="0.01" placeholder="0.00"></div>
        <div class="form-group"><label>F/L L (mÂ³)</label><input type="number" id="n_fl" step="0.01" placeholder="0.00"></div>
        <div class="form-group"><label>Ogr. Cijepani (mÂ³)</label><input type="number" id="n_oc" step="0.01" placeholder="0.00"></div>
        <div class="form-group"><label>Ogr. Dugi (mÂ³)</label><input type="number" id="n_od" step="0.01" placeholder="0.00"></div>
      </div>
      <div class="form-actions">
        <button class="btn btn-primary" onclick="addDispozicija()">ğŸ’¾ Spremi u bazu</button>
        <button class="btn btn-ghost" onclick="clearNovaForm()">âœ• PoniÅ¡ti</button>
      </div>
    </div>
  </div>

  <!-- RUÄŒNA OTPREMA -->
  <div id="tab-otprema" class="panel">
    <div class="form-section">
      <h2>ğŸš› RuÄni unos otpreme</h2>
      <p style="color:var(--muted);font-size:13px;margin-bottom:14px;">Otpreme iz Google Sheets se automatski povlaÄe pritiskom na "Dodaj otpremu". Ova forma je za ruÄne unose koji nisu u bazi.</p>
      <div class="form-grid">
        <div class="form-group" style="grid-column:span 2">
          <label>Kupac *</label>
          <select id="o_kupac" onchange="loadKupacDisp()">
            <option value="">â€” Odaberi kupca â€”</option>
          </select>
        </div>
        <div class="form-group" style="grid-column:span 2">
          <label>Dispozicija *</label>
          <select id="o_disp" onchange="showAvail()">
            <option value="">â€” Odaberi dispoziciju â€”</option>
          </select>
        </div>
        <div class="form-group">
          <label>Datum otpreme *</label>
          <input type="date" id="o_datum">
        </div>
        <div class="form-group">
          <label>Otpremnica br.</label>
          <input type="text" id="o_broj" placeholder="npr. OTP-001">
        </div>
      </div>
      <div id="availWrap" style="display:none;">
        <div class="section-label">ğŸ’° RaspoloÅ¾ivo stanje</div>
        <div class="avail-grid" id="availGrid"></div>
      </div>
      <div class="section-label">ğŸ“¦ KoliÄine otpreme</div>
      <div class="form-grid">
        <div class="form-group"><label>Trupci ÄŒ (mÂ³)</label><input type="number" id="o_tc" step="0.01" placeholder="0.00" oninput="chkAvail('tc')"></div>
        <div class="form-group"><label>Rudno (mÂ³)</label><input type="number" id="o_rud" step="0.01" placeholder="0.00" oninput="chkAvail('rud')"></div>
        <div class="form-group"><label>Cel. Duga (mÂ³)</label><input type="number" id="o_cd" step="0.01" placeholder="0.00" oninput="chkAvail('cd')"></div>
        <div class="form-group"><label>Cel. Cij. (mÂ³)</label><input type="number" id="o_cc" step="0.01" placeholder="0.00" oninput="chkAvail('cc')"></div>
        <div class="form-group"><label>Trupci L (mÂ³)</label><input type="number" id="o_tl" step="0.01" placeholder="0.00" oninput="chkAvail('tl')"></div>
        <div class="form-group"><label>F/L (mÂ³)</label><input type="number" id="o_fl" step="0.01" placeholder="0.00" oninput="chkAvail('fl')"></div>
        <div class="form-group"><label>Ogr. Cij. (mÂ³)</label><input type="number" id="o_oc" step="0.01" placeholder="0.00" oninput="chkAvail('oc')"></div>
        <div class="form-group"><label>Ogr. Dugi (mÂ³)</label><input type="number" id="o_od" step="0.01" placeholder="0.00" oninput="chkAvail('od')"></div>
      </div>
      <div id="oWarn" style="color:var(--red);font-size:13px;margin-top:10px;min-height:18px;"></div>
      <div class="form-actions">
        <button class="btn btn-success" onclick="submitOtprema()">âœ… Potvrdi otpremu</button>
        <button class="btn btn-ghost" onclick="clearOtprema()">âœ• PoniÅ¡ti</button>
      </div>
    </div>
  </div>

  <!-- HISTORIJA -->
  <div id="tab-historija" class="panel">
    <div class="search-bar">
      <input type="text" id="hSearch" placeholder="PretraÅ¾i po kupcu, datumu..." oninput="renderHistorija()">
      <label><input type="checkbox" id="hOnlySheet" onchange="renderHistorija()"> Samo iz Google Sheets</label>
      <label><input type="checkbox" id="hOnlyManual" onchange="renderHistorija()"> Samo ruÄne</label>
      <button class="btn btn-danger" id="btnDeleteAll" onclick="deleteAllOtp()" style="margin-left:auto">ğŸ—‘ ObriÅ¡i sve</button>
    </div>
    <div id="historijaList"></div>
  </div>
</main>

<!-- CONFIRM MODAL -->
<div class="modal-bg" id="confirmModal">
  <div class="modal">
    <h3>âš ï¸ Potvrda otpreme</h3>
    <div id="confirmText" style="color:var(--muted);margin-bottom:18px;line-height:1.8;font-size:14px;"></div>
    <div style="display:flex;gap:10px;">
      <button class="btn btn-success" onclick="confirmOtprema()">âœ… Potvrdi</button>
      <button class="btn btn-ghost" onclick="closeModal()">Odustani</button>
    </div>
  </div>
</div>

<!-- EDIT DISPOZICIJA MODAL -->
<div class="modal-bg" id="editModal">
  <div class="modal" style="max-width:700px">
    <h3>âœï¸ Uredi dispoziciju</h3>
    <input type="hidden" id="e_id">
    <div class="form-grid" style="margin-bottom:14px">
      <div class="form-group" style="grid-column:span 2">
        <label>Kupac *</label>
        <select id="e_kupac"><option value="">â€” Odaberi kupca â€”</option></select>
      </div>
      <div class="form-group">
        <label>Broj dispozicije *</label>
        <input type="text" id="e_broj">
      </div>
      <div class="form-group">
        <label>Datum</label>
        <input type="date" id="e_datum">
      </div>
      <div class="form-group" style="grid-column:span 2">
        <label>Ugovor</label>
        <input type="text" id="e_ugovor">
      </div>
    </div>
    <div class="section-label">ğŸŒ² ÄŒETINARI</div>
    <div class="form-grid" style="margin-bottom:14px">
      <div class="form-group"><label>Trupci I-III (mÂ³)</label><input type="number" id="e_tc" step="0.01" placeholder="0.00"></div>
      <div class="form-group"><label>Rudno / RD (mÂ³)</label><input type="number" id="e_rud" step="0.01" placeholder="0.00"></div>
      <div class="form-group"><label>Cel. Duga (mÂ³)</label><input type="number" id="e_cd" step="0.01" placeholder="0.00"></div>
      <div class="form-group"><label>Cel. Cijepana (mÂ³)</label><input type="number" id="e_cc" step="0.01" placeholder="0.00"></div>
    </div>
    <div class="section-label">ğŸ‚ LIÅ Ä†ARI</div>
    <div class="form-grid" style="margin-bottom:18px">
      <div class="form-group"><label>Trupci I-III (mÂ³)</label><input type="number" id="e_tl" step="0.01" placeholder="0.00"></div>
      <div class="form-group"><label>F/L L (mÂ³)</label><input type="number" id="e_fl" step="0.01" placeholder="0.00"></div>
      <div class="form-group"><label>Ogr. Cijepani (mÂ³)</label><input type="number" id="e_oc" step="0.01" placeholder="0.00"></div>
      <div class="form-group"><label>Ogr. Dugi (mÂ³)</label><input type="number" id="e_od" step="0.01" placeholder="0.00"></div>
    </div>
    <div style="display:flex;gap:10px;">
      <button class="btn btn-primary" onclick="saveDisp()">ğŸ’¾ Spremi promjene</button>
      <button class="btn btn-ghost" onclick="closeEditModal()">Odustani</button>
    </div>
  </div>
</div>

<!-- SYNC DATE MODAL -->
<div class="modal-bg" id="syncModal">
  <div class="modal" style="max-width:440px">
    <h3>ğŸ“… Odaberi datume za sinkronizaciju</h3>
    <p style="color:var(--muted);font-size:13px;margin-bottom:18px">
      OznaÄi datume Äije otpreme Å¾eliÅ¡ preuzeti iz <strong>INDEKS_OTPREMA</strong>.
    </p>
    <div id="syncDateList" style="display:flex;flex-direction:column;gap:8px;margin-bottom:18px"></div>
    <label id="syncTodayRow" style="display:flex;align-items:center;gap:12px;padding:11px 14px;background:var(--surface2);border-radius:8px;cursor:pointer;border:1px solid var(--border);margin-bottom:8px">
      <input type="checkbox" id="syncTodayCheck" style="width:16px;height:16px;accent-color:var(--accent);flex-shrink:0">
      <span style="font-weight:700;font-size:15px;display:flex;align-items:center;gap:6px">
        Danas <em id="syncTodayDate" style="font-size:11px;font-weight:400;color:var(--accent)"></em>
      </span>
      <span id="syncTodayStatus" style="margin-left:auto;font-size:12px;color:var(--muted)"></span>
    </label>
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:22px;padding:12px;background:var(--surface2);border-radius:8px;border:1px solid var(--border);margin-top:8px">
      <label style="font-size:13px;color:var(--muted);white-space:nowrap;font-weight:600">Drugi datum:</label>
      <input type="text" id="syncCustomDate" placeholder="dd.mm.yyyy" maxlength="10"
        style="flex:1;background:var(--surface);border:1px solid var(--border);color:var(--text);border-radius:6px;padding:6px 10px;font-size:13px;font-family:monospace;letter-spacing:1px">
    </div>
    <div style="display:flex;gap:10px">
      <button class="btn btn-primary" onclick="doSync()">ğŸ”„ Sinkroniziraj odabrane</button>
      <button class="btn btn-ghost" onclick="closeSyncModal()">Odustani</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- MOBILE BOTTOM NAV -->
<nav class="mobile-nav" id="mobileNav">
  <button class="mnav-btn active" data-tab="pregled" onclick="switchTab('pregled')">
    <span class="mni">ğŸ“‹</span><span class="mnl">Pregled</span>
  </button>
  <button class="mnav-btn" data-tab="nova" onclick="switchTab('nova')">
    <span class="mni">â•</span><span class="mnl">Nova</span>
  </button>
  <button class="mnav-btn" onclick="syncSheet()">
    <span class="mni">ğŸ”„</span><span class="mnl">Otprema</span>
  </button>
  <button class="mnav-btn" data-tab="otprema" onclick="switchTab('otprema')">
    <span class="mni">ğŸš›</span><span class="mnl">RuÄno</span>
  </button>
  <button class="mnav-btn" data-tab="historija" onclick="switchTab('historija')">
    <span class="mni">ğŸ“œ</span><span class="mnl">Historija</span>
  </button>
</nav>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SHEET_ID  = '1DIpllQlrMJwE9wpF1Gtwbnbh6ghYM5f1PimSK2gwVQQ';
const SHEET_NAME = 'INDEKS_OTPREMA';
const BAZA_SHEET = 'SPISAK KUPACA';
const FIELDS = ['tc','rud','cd','cc','tl','fl','oc','od'];
const FL = {tc:'Trupci ÄŒ',rud:'Rudno/RD',cd:'Cel.Duga',cc:'Cel.Cij.',tl:'Trupci L',fl:'F/L',oc:'Ogr.Cij.',od:'Ogr.Dugi'};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let dispozicije = [];
let otpreme     = [];
let kupacList   = [];
let pendingOtp  = null;
let db, fs;
let sortCol = null;   // null = abecedno po kupcu
let sortDir = 1;      // 1 = asc, -1 = desc

function sortBy(col) {
  if (sortCol === col) {
    sortDir *= -1;
  } else {
    sortCol = col;
    sortDir = col === 'kupac' ? 1 : -1; // kupac â†’ A-Z, sortimenti â†’ najveÄ‡e prvo
  }
  document.querySelectorAll('.sortable').forEach(th => th.classList.remove('sort-asc','sort-desc'));
  const th = document.getElementById('th-' + col);
  if (th) th.classList.add(sortDir === 1 ? 'sort-asc' : 'sort-desc');
  renderPregled();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DEFAULT DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DEFAULT_DISP = [
  {id:'d1', kupac:'ASIM KOMERC',      broj:'131/26-T',   datum:'2026-02-16', ugovor:'01-94-1/26',              tc:100,  rud:0,    cd:0,     cc:0,  tl:100,  fl:0,    oc:0,      od:0},
  {id:'d2', kupac:'AA Å½ITO',          broj:'69/26-OG',   datum:'2026-02-05', ugovor:'PredraÄun 26-0100-000009', tc:0,    rud:0,    cd:0,     cc:0,  tl:0,    fl:0,    oc:0,      od:3.21},
  {id:'d3', kupac:'AA Å½ITO',          broj:'97/26-OG',   datum:'2026-02-13', ugovor:'01-572-1/26',             tc:0,    rud:0,    cd:0,     cc:0,  tl:0,    fl:0,    oc:0,      od:150},
  {id:'d4', kupac:'BAJRAMOVIÄ†',       broj:'9/26-T',     datum:'2026-01-16', ugovor:'01-108-1/26',             tc:45.20,rud:0,    cd:0,     cc:0,  tl:0,    fl:0,    oc:0,      od:0},
  {id:'d5', kupac:'BAJRAMOVIÄ†',       broj:'37/26-T',    datum:'2026-01-21', ugovor:'01-108-1/26',             tc:50,   rud:0,    cd:0,     cc:0,  tl:0,    fl:0,    oc:0,      od:0},
  {id:'d6', kupac:'BAJRAMOVIÄ†',       broj:'73/26-T',    datum:'2026-02-02', ugovor:'01-108-1/26',             tc:104,  rud:0,    cd:0,     cc:0,  tl:0,    fl:0,    oc:0,      od:0},
  {id:'d7', kupac:'BAJRAMOVIÄ†',       broj:'106/26-OG',  datum:'2026-02-17', ugovor:'01-61-1/26',              tc:0,    rud:0,    cd:0,     cc:0,  tl:0,    fl:0,    oc:0,      od:49},
  {id:'d8', kupac:'BOR',              broj:'60/26-T',    datum:'2026-01-28', ugovor:'01-82-1/26',              tc:0,    rud:0,    cd:0,     cc:0,  tl:24.60,fl:0,    oc:0,      od:0},
  {id:'d9', kupac:'DIVA',             broj:'2/25-T',     datum:'2026-01-13', ugovor:'01-83-1/25',              tc:0,    rud:0,    cd:0,     cc:0,  tl:24.90,fl:0,    oc:0,      od:0},
  {id:'d10',kupac:'DIVA',             broj:'68/26-T',    datum:'2026-01-30', ugovor:'01-83-1/25',              tc:0,    rud:0,    cd:0,     cc:0,  tl:50,   fl:0,    oc:0,      od:0},
  {id:'d11',kupac:'DIVA',             broj:'105/26-T',   datum:'2026-02-06', ugovor:'Javor 01-374-1/26',       tc:0,    rud:0,    cd:0,     cc:0,  tl:4.96, fl:0,    oc:0,      od:0},
  {id:'d12',kupac:'EURO UNA',         broj:'25/26-T',    datum:'2026-01-20', ugovor:'01-84-1/26',              tc:0,    rud:0,    cd:0,     cc:0,  tl:47.88,fl:0,    oc:0,      od:0},
  {id:'d13',kupac:'EURO UNA',         broj:'82/26-T',    datum:'2026-02-03', ugovor:'01-84-1/26',              tc:0,    rud:0,    cd:0,     cc:0,  tl:50,   fl:0,    oc:0,      od:0},
  {id:'d14',kupac:'HNK COMPANY',      broj:'5/26-T',     datum:'2026-01-15', ugovor:'01-90-1/26',              tc:0,    rud:0,    cd:0,     cc:0,  tl:4.39, fl:0,    oc:0,      od:0},
  {id:'d15',kupac:'HNK COMPANY',      broj:'29/26-T',    datum:'2026-01-20', ugovor:'01-90-1/26',              tc:0,    rud:0,    cd:0,     cc:0,  tl:60,   fl:0,    oc:0,      od:0},
  {id:'d16',kupac:'HNK COMPANY',      broj:'144/26-T',   datum:'2026-02-17', ugovor:'01-90-1/26',              tc:0,    rud:0,    cd:0,     cc:0,  tl:56,   fl:0,    oc:0,      od:0},
  {id:'d17',kupac:'HUSETIÄ†',          broj:'21/26-T',    datum:'2026-01-20', ugovor:'01-102-1/26',             tc:66.80,rud:0,    cd:0,     cc:0,  tl:0,    fl:0,    oc:0,      od:0},
  {id:'d18',kupac:'HOLZ TRANSPORTI',  broj:'64/26-OG',   datum:'2026-02-05', ugovor:'01-42-1/26',              tc:0,    rud:0,    cd:0,     cc:0,  tl:0,    fl:0,    oc:399.89, od:0},
  {id:'d19',kupac:'IZUDIN',           broj:'89/26-T',    datum:'2026-02-03', ugovor:'01-99-1/26',              tc:30,   rud:0,    cd:0,     cc:0,  tl:0,    fl:0,    oc:0,      od:0},
  {id:'d20',kupac:'IZUDIN',           broj:'57/26-OG',   datum:'2026-02-03', ugovor:'01-43-1/26',              tc:0,    rud:0,    cd:0,     cc:0,  tl:0,    fl:0,    oc:0,      od:2.65},
  {id:'d21',kupac:'LONIÄ† COMP',       broj:'53/26-T',    datum:'2026-01-28', ugovor:'01-92-1/26',              tc:100,  rud:0,    cd:0,     cc:0,  tl:0,    fl:0,    oc:0,      od:0},
  {id:'d22',kupac:'LONIÄ† COMP',       broj:'54/26-T',    datum:'2026-01-28', ugovor:'01-92-1/26',              tc:0,    rud:0,    cd:0,     cc:0,  tl:38.52,fl:0,    oc:0,      od:0},
  {id:'d23',kupac:'LONIÄ† COMP',       broj:'112/26-OG',  datum:'2026-02-18', ugovor:'01-45-1/26',              tc:0,    rud:0,    cd:0,     cc:0,  tl:0,    fl:0,    oc:0,      od:83.89},
  {id:'d24',kupac:'LONIÄ† COMP',       broj:'49/26-C',    datum:'2026-02-12', ugovor:'26-0100-000014',          tc:0,    rud:0,    cd:0,     cc:21, tl:0,    fl:0,    oc:0,      od:0},
  {id:'d25',kupac:'LELIÄ† KOMERC',     broj:'80/26-OG',   datum:'2026-02-10', ugovor:'01-44-1/26',              tc:0,    rud:0,    cd:0,     cc:0,  tl:0,    fl:0,    oc:0,      od:1.86},
  {id:'d26',kupac:'LELIÄ† KOMERC',     broj:'109/26-OG',  datum:'2026-02-17', ugovor:'26-0100-000016',          tc:0,    rud:0,    cd:0,     cc:0,  tl:0,    fl:24.70,oc:0,      od:0},
  {id:'d27',kupac:'M-EKO',            broj:'67/26-OG',   datum:'2026-02-05', ugovor:'01-55-1/26',              tc:0,    rud:0,    cd:0,     cc:0,  tl:0,    fl:0,    oc:15.18,  od:0},
  {id:'d28',kupac:'M-EKO',            broj:'82/26-OG',   datum:'2026-02-10', ugovor:'01-55-1/26',              tc:0,    rud:0,    cd:0,     cc:0,  tl:0,    fl:0,    oc:100,    od:0},
  {id:'d29',kupac:'POGY',             broj:'7/26-T',     datum:'2026-01-15', ugovor:'01-85-1/26',              tc:0,    rud:0,    cd:0,     cc:0,  tl:10.74,fl:0,    oc:0,      od:0},
  {id:'d30',kupac:'POGY',             broj:'86/26-T',    datum:'2026-02-03', ugovor:'01-85-1/26',              tc:0,    rud:0,    cd:0,     cc:0,  tl:120,  fl:0,    oc:0,      od:0},
  {id:'d31',kupac:'POGY',             broj:'98/26-T',    datum:'2026-02-05', ugovor:'01-85-1/26',              tc:0,    rud:0,    cd:0,     cc:0,  tl:100,  fl:0,    oc:0,      od:0},
  {id:'d32',kupac:'SANI GLOBAL',      broj:'116/26-T',   datum:'2026-02-11', ugovor:'01-384-1/26',             tc:1.18, rud:0,    cd:0,     cc:0,  tl:0,    fl:0,    oc:0,      od:0},
  {id:'d33',kupac:'SANI GLOBAL',      broj:'39/26-C',    datum:'2026-02-09', ugovor:'01-26-1/26',              tc:0,    rud:0,    cd:13.89, cc:0,  tl:0,    fl:0,    oc:0,      od:0},
  {id:'d34',kupac:'SANI GLOBAL',      broj:'108/26-T',   datum:'2026-02-09', ugovor:'01-86-1/26',              tc:0,    rud:0,    cd:0,     cc:0,  tl:42.09,fl:0,    oc:0,      od:0},
  {id:'d35',kupac:'Å UMAPROMET',       broj:'84/26-OG',   datum:'2026-02-11', ugovor:'01-39-1/26',              tc:0,    rud:0,    cd:0,     cc:0,  tl:0,    fl:0,    oc:0,      od:58.47},
  {id:'d36',kupac:'VITA JELA',        broj:'70/26-T',    datum:'2026-01-30', ugovor:'01-112-1/26',             tc:100,  rud:0,    cd:0,     cc:0,  tl:0,    fl:0,    oc:0,      od:0},
  {id:'d37',kupac:'VITA JELA',        broj:'52/26-OG',   datum:'2026-02-03', ugovor:'01-65-1/26',              tc:0,    rud:0,    cd:0,     cc:0,  tl:0,    fl:0,    oc:0,      od:6.90},
  {id:'d38',kupac:'SEKTOR EKOLOGIJE', broj:'2/26-TR',    datum:'2026-01-12', ugovor:'Trebov. 1/26',            tc:464.81,rud:0,   cd:0,     cc:0,  tl:0,    fl:0,    oc:0,      od:141.56},
  {id:'d39',kupac:'DRVO OBRT',        broj:'06/26-OG',   datum:'2026-01-19', ugovor:'01-67-1/26',              tc:0,    rud:0,    cd:0,     cc:0,  tl:0,    fl:0,    oc:0,      od:0},
  {id:'d40',kupac:'DRVO OBRT',        broj:'62/26-OG',   datum:'2026-02-04', ugovor:'01-67-1/26',              tc:0,    rud:0,    cd:0,     cc:0,  tl:0,    fl:0,    oc:0,      od:0.19},
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FIREBASE INIT & REALTIME LISTENERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function initFirebase() {
  setLoader('Spajanje na Firebase...');
  // Wait for Firebase module to load
  let attempts = 0;
  while (!window._firebaseReady && attempts < 50) {
    await sleep(100);
    attempts++;
  }
  if (!window._firebaseReady) {
    setLoader('âŒ Firebase se nije uÄitao. Provjerite internet vezu.');
    return;
  }
  db = window._db;
  fs = window._fb;

  setLoader('UÄitavanje kupaca...');
  await loadKupacList();
  setLoader('UÄitavanje dispozicija...');

  // â”€â”€ seed defaults if Firestore is empty â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const dispSnap = await fs.getDocs(fs.collection(db, 'dispozicije'));
  if (dispSnap.empty) {
    setLoader('Inicijalno punjenje baze...');
    const batch = fs.writeBatch(db);
    DEFAULT_DISP.forEach(d => {
      batch.set(fs.doc(db, 'dispozicije', d.id), d);
    });
    await batch.commit();
  }

  // â”€â”€ realtime listeners â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  fs.onSnapshot(fs.collection(db, 'dispozicije'), snap => {
    dispozicije = snap.docs.map(d => ({id: d.id, ...d.data()}));
    dispozicije.sort((a,b) => a.kupac.localeCompare(b.kupac) || (a.datum||'').localeCompare(b.datum||''));
    renderAll();
  });

  fs.onSnapshot(fs.collection(db, 'otpreme'), snap => {
      otpreme = snap.docs.map(d => ({id: d.id, ...d.data()}));
      otpreme.sort((a,b) => (b.datum||'').localeCompare(a.datum||''));
      renderAll();
    });

  // â”€â”€ meta: last sync time â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  try {
    const metaSnap = await fs.getDocs(fs.collection(db, 'meta'));
    metaSnap.forEach(d => {
      if (d.id === 'sync') updateSyncStatus(d.data().lastSync);
    });
  } catch(e) {}

  // Show app
  document.getElementById('loader').style.display = 'none';
  document.getElementById('mainHeader').style.display = 'flex';
  document.getElementById('mainContent').style.display = 'block';
  document.getElementById('dateBadge').textContent =
    new Date().toLocaleDateString('bs-BA',{day:'2-digit',month:'2-digit',year:'numeric'});
}

async function loadKupacList() {
  try {
    const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(BAZA_SHEET)}&range=A2:A500&headers=0`;
    const res  = await fetch(url);
    const text = await res.text();
    const json = JSON.parse(text.slice(text.indexOf('{'), text.lastIndexOf('}')+1));
    kupacList = (json.table.rows || [])
      .map(r => r.c && r.c[0] && r.c[0].v ? String(r.c[0].v).trim() : '')
      .filter(Boolean)
      .sort((a,b) => a.localeCompare(b));
  } catch(e) {
    console.warn('Nije moguÄ‡e uÄitati listu kupaca iz Sheets:', e);
    kupacList = [];
  }
}

function setLoader(msg) {
  document.getElementById('loaderMsg').textContent = msg;
}
function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }
// Lokalni datum YYYY-MM-DD (izbjegava UTC pomak toISOString)
function localDateStr(date) {
  const d = (date instanceof Date) ? date : new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FIRESTORE CRUD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function fbSetDisp(d) {
  if (!fs||!db) return;
  await fs.setDoc(fs.doc(db, 'dispozicije', d.id), d);
}
async function fbDelDisp(id) {
  if (!fs||!db) return;
  await fs.deleteDoc(fs.doc(db, 'dispozicije', id));
}
async function fbSetOtp(o) {
  if (!fs||!db) return;
  await fs.setDoc(fs.doc(db, 'otpreme', o.id), o);
}
async function fbDelOtp(id) {
  if (!fs||!db) return;
  await fs.deleteDoc(fs.doc(db, 'otpreme', id));
}
async function fbSetMeta(key, data) {
  if (!fs||!db) return;
  await fs.setDoc(fs.doc(db, 'meta', key), data);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BALANCE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getBalance(disp) {
  const _today = new Date(); _today.setHours(0,0,0,0);
  const _todayStr = localDateStr(_today);
  const spent = {tc:0,rud:0,cd:0,cc:0,tl:0,fl:0,oc:0,od:0};
  otpreme
    .filter(o => o.disp_id === disp.id && (!o.datum || o.datum <= _todayStr))
    .forEach(o => { FIELDS.forEach(f => spent[f] += (o[f]||0)); });
  const bal = {};
  FIELDS.forEach(f => bal[f] = (disp[f]||0) - spent[f]);
  return bal;
}

function balStatus(disp) {
  const bal = getBalance(disp);
  const total = FIELDS.reduce((s,f) => s + (disp[f]||0), 0);
  const rem   = FIELDS.reduce((s,f) => s + bal[f], 0);
  if (total === 0) return 'empty';
  if (rem < 0)             return 'over';
  if (rem / total <= 0.05) return 'done';
  if (rem / total <= 0.30) return 'low';
  if (rem < 20) return 'low';
  return 'ok';
}

// Provjeri je li dispozicija iscrpljena unutar zadnjih 24h
function isRecentlyExhausted(disp) {
  const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1);
  const yesterdayStr = localDateStr(yesterday);
  return otpreme.some(o => o.disp_id === disp.id && (o.datum||'') >= yesterdayStr);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER â€“ PREGLED
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function datumAge(datumStr) {
  if (!datumStr) return null;
  const today = new Date(); today.setHours(0,0,0,0);
  const d = new Date(datumStr); d.setHours(0,0,0,0);
  return Math.round((today - d) / 86400000);
}
function datumColor(datumStr) {
  const age = datumAge(datumStr);
  if (age === null) return '';
  if (age <= 7)  return 'color:#22c55e;font-weight:700';   // zelena
  if (age <= 14) return 'color:#3b82f6;font-weight:700';   // plava
  if (age <= 21) return 'color:#a855f7;font-weight:700';   // ljubiÄasta
  return                 'color:#ef4444;font-weight:700';   // crvena
}

function fmtBal(bal, orig) {
  const v = parseFloat(bal.toFixed(2));
  const o = parseFloat((orig||0).toFixed(2));
  if (o === 0) return '';
  const pct = Math.max(0, Math.min(100, o>0 ? v/o*100 : 0));
  const cls    = v < 0 ? 'neg'  : v < o*0.2 ? 'warn' : 'pos';
  const barCls = v < 0 ? 'prog-neg' : v < o*0.2 ? 'prog-warn' : 'prog-ok';
  return `<span class="${cls}" style="font-size:15px;font-weight:600">${v}</span>
          <div class="prog-wrap"><div class="prog-bar ${barCls}" style="width:${pct}%"></div></div>`;
}

function renderPregled() {
  const search   = (document.getElementById('searchInput')?.value||'').toLowerCase();
  const showZero = document.getElementById('showZero')?.checked;
  const body     = document.getElementById('pregledBody');
  if (!body) return;
  const _d = new Date();
  const _dn = `${String(_d.getDate()).padStart(2,'0')}.${String(_d.getMonth()+1).padStart(2,'0')}.${_d.getFullYear()}`;
  const _naslov = document.getElementById('pregledNaslov');
  if (_naslov) _naslov.textContent = `PREGLED DISPOZICIJA NA DAN ${_dn}`;

  // Postavi indikator ako nije niÅ¡ta odabrano (default: kupac A-Z)
  if (!sortCol) {
    document.querySelectorAll('.sortable').forEach(th => th.classList.remove('sort-asc','sort-desc'));
    const thK = document.getElementById('th-kupac');
    if (thK) thK.classList.add('sort-asc');
  }

  const grouped = {};
  dispozicije.forEach(d => {
    if (!d.kupac.toLowerCase().includes(search) &&
        !(d.ugovor||'').toLowerCase().includes(search) &&
        !(d.broj||'').toLowerCase().includes(search)) return;
    const st = balStatus(d);
    if (!showZero) {
      if (st === 'empty') return;
      if (st === 'done' && !isRecentlyExhausted(d)) return; // sakrij iscrpljene starije od 24h
      // 'over' uvijek prikaÅ¾i dok minus nije pokriven
    }
    (grouped[d.kupac] = grouped[d.kupac]||[]).push(d);
  });

  const stChips = {
    ok:    '<span class="bal-chip bal-ok">âœ“ OK</span>',
    low:   '<span class="bal-chip bal-warn">âš  Malo</span>',
    done:  '<span class="bal-chip" style="background:#1a1a2e;border:1px solid #3a3a6a;color:#7a7aaa">â‰ˆ Iscrpljeno</span>',
    over:  '<span class="bal-chip bal-neg">â›” PrekoraÄeno</span>',
    empty: '<span class="bal-chip" style="background:var(--surface2);border:1px solid var(--border);color:var(--muted)">â€”</span>',
  };

  const totBal  = {tc:0,rud:0,cd:0,cc:0,tl:0,fl:0,oc:0,od:0};
  const totOrig = {tc:0,rud:0,cd:0,cc:0,tl:0,fl:0,oc:0,od:0};
  // Sortiranje kupaca i dispozicija
  let kupciKeys = Object.keys(grouped);
  if (!sortCol || sortCol === 'kupac') {
    kupciKeys.sort((a, b) => sortDir * a.localeCompare(b));
  } else {
    kupciKeys.sort((a, b) => {
      const aSum = grouped[a].reduce((s, d) => s + (getBalance(d)[sortCol] || 0), 0);
      const bSum = grouped[b].reduce((s, d) => s + (getBalance(d)[sortCol] || 0), 0);
      return sortDir * (aSum - bSum);
    });
    kupciKeys.forEach(k => {
      grouped[k].sort((a, b) => sortDir * (getBalance(a)[sortCol] - getBalance(b)[sortCol]));
    });
  }

  let totalRows = 0;
  let html = '';
  kupciKeys.forEach(kupac => {
    grouped[kupac].forEach((d, i) => {
      const bal    = getBalance(d);
      const st     = balStatus(d);
      const oCount = otpreme.filter(o => o.disp_id === d.id).length;
      html += `<tr>
        <td class="kupac">${i===0 ? kupac : ''}</td>
        <td style="font-size:15px">${d.broj}</td>
        <td style="font-size:15px;${datumColor(d.datum)}">${d.datum ? d.datum.slice(5).split('-').reverse().join('.') : 'â€”'}</td>
        <td style="font-size:15px;color:var(--muted)">${d.ugovor||''}</td>
        <td style="border-left:2px solid var(--border)">${d.tc  ? fmtBal(bal.tc,  d.tc)  : ''}</td>
        <td>${d.rud ? fmtBal(bal.rud, d.rud) : ''}</td>
        <td>${d.cd  ? fmtBal(bal.cd,  d.cd)  : ''}</td>
        <td>${d.cc  ? fmtBal(bal.cc,  d.cc)  : ''}</td>
        <td style="border-left:2px solid var(--border)">${d.tl  ? fmtBal(bal.tl,  d.tl)  : ''}</td>
        <td>${d.fl  ? fmtBal(bal.fl,  d.fl)  : ''}</td>
        <td>${d.oc  ? fmtBal(bal.oc,  d.oc)  : ''}</td>
        <td>${d.od  ? fmtBal(bal.od,  d.od)  : ''}</td>
        <td>${stChips[st]||''} ${oCount>0?`<span style="font-size:11px;color:var(--muted)">(${oCount} otp.)</span>`:''}</td>
        <td style="white-space:nowrap">
          <button class="edit-disp-btn" onclick="editDisp('${d.id}')" title="Uredi">âœï¸ Edit</button>
          <button class="del-disp-btn" onclick="deleteDisp('${d.id}')" title="ObriÅ¡i">ğŸ—‘</button>
        </td>
      </tr>`;
      FIELDS.forEach(f => { totBal[f] += bal[f]; totOrig[f] += (d[f]||0); });
      totalRows++;
    });
  });

  if (totalRows > 1) {
    html += `<tr class="total-row">
      <td colspan="4">UKUPNO</td>
      <td style="border-left:2px solid var(--border)">${totOrig.tc  ? fmtBal(totBal.tc,  totOrig.tc)  : ''}</td>
      <td>${totOrig.rud ? fmtBal(totBal.rud, totOrig.rud) : ''}</td>
      <td>${totOrig.cd  ? fmtBal(totBal.cd,  totOrig.cd)  : ''}</td>
      <td>${totOrig.cc  ? fmtBal(totBal.cc,  totOrig.cc)  : ''}</td>
      <td style="border-left:2px solid var(--border)">${totOrig.tl  ? fmtBal(totBal.tl,  totOrig.tl)  : ''}</td>
      <td>${totOrig.fl  ? fmtBal(totBal.fl,  totOrig.fl)  : ''}</td>
      <td>${totOrig.oc  ? fmtBal(totBal.oc,  totOrig.oc)  : ''}</td>
      <td>${totOrig.od  ? fmtBal(totBal.od,  totOrig.od)  : ''}</td>
      <td colspan="2"></td>
    </tr>`;
  }

  body.innerHTML = html ||
    `<tr><td colspan="14"><div class="empty-state"><div class="big">ğŸ“­</div><p>Nema dispozicija</p></div></td></tr>`;

  // â”€â”€ Mobile card view â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let mhtml = '';
  kupciKeys.forEach(kupac => {
    grouped[kupac].forEach(d => {
      const bal    = getBalance(d);
      const st     = balStatus(d);
      const oCount = otpreme.filter(o => o.disp_id === d.id).length;
      const nonZero = FIELDS.filter(f => d[f]);
      const datFmt  = d.datum ? d.datum.slice(5).split('-').reverse().join('.') + '.' + d.datum.slice(2,4) : 'â€”';
      mhtml += `<div class="mob-card">
        <div class="mob-head">
          <div class="mob-kupac">${kupac}</div>
          <div style="font-size:13px;font-weight:700;${datumColor(d.datum)}">${datFmt}</div>
        </div>
        <div class="mob-meta">
          <span>${d.broj||'â€”'}</span>
          ${d.ugovor ? `<span style="opacity:.7">${d.ugovor}</span>` : ''}
        </div>
        ${nonZero.length ? `<div class="mob-vals">${nonZero.map(f => {
          const v = parseFloat(bal[f].toFixed(2));
          const o = parseFloat((d[f]||0).toFixed(2));
          const cls = v<0 ? 'neg' : v<o*0.2 ? 'warn' : 'pos';
          const pct = Math.max(0, Math.min(100, o>0 ? v/o*100 : 0));
          const bc  = v<0 ? 'prog-neg' : v<o*0.2 ? 'prog-warn' : 'prog-ok';
          return `<div class="mob-val">
            <div class="mvl">${FL[f]}</div>
            <div class="mvv ${cls}">${v}</div>
            <div class="prog-wrap"><div class="prog-bar ${bc}" style="width:${pct}%"></div></div>
          </div>`;
        }).join('')}</div>` : ''}
        <div class="mob-foot">
          ${stChips[st]||''}
          ${oCount>0 ? `<span style="font-size:11px;color:var(--muted)">(${oCount} otp.)</span>` : ''}
          <div class="mob-acts">
            <button class="edit-disp-btn" onclick="editDisp('${d.id}')">âœï¸ Edit</button>
            <button class="del-disp-btn" onclick="deleteDisp('${d.id}')">ğŸ—‘</button>
          </div>
        </div>
      </div>`;
    });
  });
  const mobList = document.getElementById('mob-list');
  if (mobList) mobList.innerHTML = mhtml || '<div class="empty-state"><div class="big">ğŸ“­</div><p>Nema dispozicija</p></div>';

  renderStatusBar();
}

function renderStatusBar() {
  const sb = document.getElementById('statusBar');
  if (!sb) return;
  const kupci = [...new Set(dispozicije.map(d=>d.kupac))].length;
  // Sume originalnih (uplaÄ‡enih) dispozicija po sortimentu
  const orig={tc:0,rud:0,cd:0,cc:0,tl:0,fl:0,oc:0,od:0};
  dispozicije.forEach(d => FIELDS.forEach(f => orig[f]+=(d[f]||0)));
  const tO = FIELDS.reduce((s,f)=>s+orig[f],0);

  // Sume po sortimentima samo za aktivne (ne-empty) dispozicije
  const sortLabels = {tc:'Trupci ÄŒ',rud:'Rudno',cd:'Cel.Duga',cc:'Cel.Cij.',
                      tl:'Trupci L',fl:'F/L',oc:'Ogr.Cij.',od:'Ogr.Dugi'};
  const sortHtml = FIELDS.filter(f=>orig[f]>0).map(f =>
    `<div class="divider"></div>
     <div class="stat"><div class="sl">${sortLabels[f]}</div><div class="sv" style="color:var(--text);font-size:16px">${orig[f].toFixed(2)}</div></div>`
  ).join('');

  sb.innerHTML = `
    <div class="stat"><div class="sl">Dispozicija</div><div class="sv yellow">${dispozicije.length}</div></div>
    <div class="divider"></div>
    <div class="stat"><div class="sl">Kupaca</div><div class="sv yellow">${kupci}</div></div>
    <div class="divider"></div>
    <div class="stat"><div class="sl">Ukupno dispozicija</div><div class="sv yellow">${tO.toFixed(2)} mÂ³</div></div>
    ${sortHtml}`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NOVA DISPOZICIJA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderNova() {
  const sel = document.getElementById('n_kupac');
  if (sel) {
    const src = kupacList.length ? kupacList : [...new Set(dispozicije.map(d=>d.kupac))].sort();
    sel.innerHTML = '<option value="">â€” Odaberi kupca â€”</option>' +
      src.map(k=>`<option value="${k}">${k}</option>`).join('');
  }
  document.getElementById('n_datum').value = localDateStr();
}

async function addDispozicija() {
  const kupac = document.getElementById('n_kupac').value.trim();
  const broj  = document.getElementById('n_broj').value.trim();
  if (!kupac||!broj) { showToast('Kupac i broj su obavezni!','error'); return; }
  const d = {
    id: 'd' + Date.now(),
    kupac, broj,
    datum:  document.getElementById('n_datum').value,
    ugovor: document.getElementById('n_ugovor').value.trim(),
    tc:  parseFloat(document.getElementById('n_tc').value)||0,
    rud: parseFloat(document.getElementById('n_rud').value)||0,
    cd:  parseFloat(document.getElementById('n_cd').value)||0,
    cc:  parseFloat(document.getElementById('n_cc').value)||0,
    tl:  parseFloat(document.getElementById('n_tl').value)||0,
    fl:  parseFloat(document.getElementById('n_fl').value)||0,
    oc:  parseFloat(document.getElementById('n_oc').value)||0,
    od:  parseFloat(document.getElementById('n_od').value)||0,
  };
  await fbSetDisp(d);
  clearNovaForm();
  showToast(`âœ… Dispozicija "${broj}" za "${kupac}" dodana!`, 'success');
  switchTab('pregled');
}

function clearNovaForm() {
  ['n_kupac','n_broj','n_ugovor','n_tc','n_rud','n_cd','n_cc','n_tl','n_fl','n_oc','n_od']
    .forEach(id => { document.getElementById(id).value = ''; });
  document.getElementById('n_datum').value = localDateStr();
}

async function deleteDisp(id) {
  if (!confirm('ObriÅ¡i dispoziciju? Otpreme u historiji ostaju.')) return;
  await fbDelDisp(id);
  showToast('Dispozicija obrisana','success');
}

function editDisp(id) {
  const d = dispozicije.find(x => x.id === id);
  if (!d) return;
  // Popuni select kupaca
  const sel = document.getElementById('e_kupac');
  const src = kupacList.length ? kupacList : [...new Set(dispozicije.map(x=>x.kupac))].sort();
  sel.innerHTML = '<option value="">â€” Odaberi kupca â€”</option>' +
    src.map(k=>`<option value="${k}">${k}</option>`).join('');
  // Ako kupac nije u listi, dodaj ga
  if (d.kupac && !src.includes(d.kupac)) {
    const opt = document.createElement('option');
    opt.value = d.kupac; opt.textContent = d.kupac;
    sel.appendChild(opt);
  }
  document.getElementById('e_id').value    = d.id;
  sel.value = d.kupac || '';
  document.getElementById('e_broj').value  = d.broj  || '';
  document.getElementById('e_datum').value = d.datum || '';
  document.getElementById('e_ugovor').value= d.ugovor|| '';
  document.getElementById('e_tc').value    = d.tc  || '';
  document.getElementById('e_rud').value   = d.rud || '';
  document.getElementById('e_cd').value    = d.cd  || '';
  document.getElementById('e_cc').value    = d.cc  || '';
  document.getElementById('e_tl').value    = d.tl  || '';
  document.getElementById('e_fl').value    = d.fl  || '';
  document.getElementById('e_oc').value    = d.oc  || '';
  document.getElementById('e_od').value    = d.od  || '';
  document.getElementById('editModal').classList.add('open');
}

async function saveDisp() {
  const id    = document.getElementById('e_id').value;
  const kupac = document.getElementById('e_kupac').value.trim();
  const broj  = document.getElementById('e_broj').value.trim();
  if (!kupac||!broj) { showToast('Kupac i broj su obavezni!','error'); return; }
  const d = {
    id, kupac, broj,
    datum:  document.getElementById('e_datum').value,
    ugovor: document.getElementById('e_ugovor').value.trim(),
    tc:  parseFloat(document.getElementById('e_tc').value)  || 0,
    rud: parseFloat(document.getElementById('e_rud').value) || 0,
    cd:  parseFloat(document.getElementById('e_cd').value)  || 0,
    cc:  parseFloat(document.getElementById('e_cc').value)  || 0,
    tl:  parseFloat(document.getElementById('e_tl').value)  || 0,
    fl:  parseFloat(document.getElementById('e_fl').value)  || 0,
    oc:  parseFloat(document.getElementById('e_oc').value)  || 0,
    od:  parseFloat(document.getElementById('e_od').value)  || 0,
  };
  await fbSetDisp(d);
  closeEditModal();
  showToast(`âœ… Dispozicija "${broj}" aÅ¾urirana!`, 'success');
}

function closeEditModal() {
  document.getElementById('editModal').classList.remove('open');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RUÄŒNA OTPREMA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderOtprema() {
  const sel = document.getElementById('o_kupac');
  const src = kupacList.length ? kupacList : [...new Set(dispozicije.map(d=>d.kupac))].sort();
  sel.innerHTML = '<option value="">â€” Odaberi kupca â€”</option>' +
    src.map(k=>`<option value="${k}">${k}</option>`).join('');
  document.getElementById('o_datum').value = localDateStr();
}

function loadKupacDisp() {
  const kupac = document.getElementById('o_kupac').value;
  const sel   = document.getElementById('o_disp');
  const kd    = dispozicije.filter(d=>d.kupac===kupac);
  sel.innerHTML = '<option value="">â€” Odaberi dispoziciju â€”</option>' +
    kd.map(d=>`<option value="${d.id}">${d.broj} | ${d.datum||''} | ${d.ugovor||''}</option>`).join('');
  document.getElementById('availWrap').style.display='none';
}

function showAvail() {
  const dispId = document.getElementById('o_disp').value;
  if (!dispId) { document.getElementById('availWrap').style.display='none'; return; }
  const disp = dispozicije.find(d=>d.id===dispId);
  const bal  = getBalance(disp);
  document.getElementById('availGrid').innerHTML = FIELDS.map(f => {
    const o = disp[f]||0;
    const b = parseFloat(bal[f].toFixed(2));
    if (o===0 && b===0) return '';
    const pct = o>0 ? Math.max(0,Math.min(100,b/o*100)) : 0;
    const col = b<0 ? 'var(--red)' : b<o*0.2 ? 'var(--accent)' : 'var(--green)';
    return `<div class="avail-item">
      <div class="al">${FL[f]}</div>
      <div class="av" style="color:${col}">${b} mÂ³</div>
      <div class="ao">od ${o} mÂ³</div>
      <div class="prog-wrap"><div class="prog-bar ${b<0?'prog-neg':b<o*0.2?'prog-warn':'prog-ok'}" style="width:${pct}%"></div></div>
    </div>`;
  }).filter(Boolean).join('');
  document.getElementById('availWrap').style.display='block';
}

function chkAvail(field) {
  const dispId = document.getElementById('o_disp').value;
  if (!dispId) return;
  const disp = dispozicije.find(d=>d.id===dispId);
  const bal  = getBalance(disp);
  const val  = parseFloat(document.getElementById('o_'+field).value)||0;
  document.getElementById('oWarn').textContent =
    val > bal[field]
      ? `âš ï¸ ${FL[field]}: unosite ${val} mÂ³, raspoloÅ¾ivo samo ${parseFloat(bal[field].toFixed(2))} mÂ³!`
      : '';
}

function submitOtprema() {
  const kupac  = document.getElementById('o_kupac').value;
  const dispId = document.getElementById('o_disp').value;
  if (!kupac||!dispId) { showToast('Odaberite kupca i dispoziciju!','error'); return; }
  const vals = {};
  let total = 0;
  FIELDS.forEach(f => { vals[f] = parseFloat(document.getElementById('o_'+f).value)||0; total += vals[f]; });
  if (total===0) { showToast('Unesite barem jednu koliÄinu!','error'); return; }
  const disp    = dispozicije.find(d=>d.id===dispId);
  const bal     = getBalance(disp);
  const overages = FIELDS.filter(f=>vals[f]>bal[f]);
  document.getElementById('confirmText').innerHTML =
    `<strong>Kupac:</strong> ${kupac}<br>
     <strong>Dispozicija:</strong> ${disp.broj}<br>
     <strong>Otpremnica:</strong> ${document.getElementById('o_broj').value||'â€”'}<br>
     <strong>Datum:</strong> ${document.getElementById('o_datum').value}<br><br>
     <strong>KoliÄine:</strong><br>
     ${FIELDS.filter(f=>vals[f]>0).map(f=>`${FL[f]}: <strong>${vals[f]} mÂ³</strong>`).join('<br>')}
     ${overages.length ? `<br><br><span style="color:var(--red)">âš ï¸ PrekoraÄenje: ${overages.map(f=>FL[f]).join(', ')}</span>` : ''}`;
  pendingOtp = {
    kupac, disp_id:dispId, ...vals,
    datum: document.getElementById('o_datum').value,
    broj:  document.getElementById('o_broj').value,
    source:'manual'
  };
  document.getElementById('confirmModal').classList.add('open');
}

async function confirmOtprema() {
  if (!pendingOtp) return;
  pendingOtp.id = 'man_' + Date.now();
  await fbSetOtp(pendingOtp);
  pendingOtp = null;
  closeModal();
  clearOtprema();
  showToast('âœ… Otprema evidentirana u bazi!','success');
  switchTab('pregled');
}

function closeModal() {
  document.getElementById('confirmModal').classList.remove('open');
  pendingOtp = null;
}

function clearOtprema() {
  document.getElementById('o_kupac').value = '';
  document.getElementById('o_disp').innerHTML = '<option value="">â€” Odaberi dispoziciju â€”</option>';
  document.getElementById('o_broj').value = '';
  document.getElementById('o_datum').value = localDateStr();
  FIELDS.forEach(f => document.getElementById('o_'+f).value = '');
  document.getElementById('availWrap').style.display = 'none';
  document.getElementById('oWarn').textContent = '';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HISTORIJA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderHistorija() {
  const search     = (document.getElementById('hSearch')?.value||'').toLowerCase();
  const onlySheet  = document.getElementById('hOnlySheet')?.checked;
  const onlyManual = document.getElementById('hOnlyManual')?.checked;
  const list       = document.getElementById('historijaList');
  let filtered = [...otpreme].filter(o => {
    if (onlySheet  && o.source!=='sheet') return false;
    if (onlyManual && o.source==='sheet') return false;
    return o.kupac.toLowerCase().includes(search) ||
           (o.broj||'').toLowerCase().includes(search) ||
           (o.datum||'').includes(search);
  });

  // Zadnjih 10 dana
  const today = new Date(); today.setHours(0,0,0,0);
  const last10 = [];
  for (let i = 0; i < 10; i++) {
    last10.push(localDateStr(new Date(today.getTime() - i * 86400000)));
  }

  // Grupiraj otpreme po datumu
  const byDate = {};
  filtered.forEach(o => {
    const d = o.datum || 'bez-datuma';
    (byDate[d] = byDate[d] || []).push(o);
  });

  // Funkcija za izraÄun ukupnog stanja na poÄetku dana
  function getBalanceAtDate(dateStr) {
    const totalOrig = {tc:0,rud:0,cd:0,cc:0,tl:0,fl:0,oc:0,od:0};
    const totalSpent = {tc:0,rud:0,cd:0,cc:0,tl:0,fl:0,oc:0,od:0};
    dispozicije.forEach(d => FIELDS.forEach(f => totalOrig[f] += (d[f]||0)));
    otpreme.filter(o => o.datum && o.datum < dateStr)
           .forEach(o => FIELDS.forEach(f => totalSpent[f] += (o[f]||0)));
    const bal = {};
    FIELDS.forEach(f => bal[f] = totalOrig[f] - totalSpent[f]);
    return bal;
  }

  let html = '';
  let hasAny = false;

  last10.forEach(dateStr => {
    const dayOtpreme = byDate[dateStr] || [];
    const [y, m, day] = dateStr.split('-');
    const label = `${day}.${m}.${y}`;
    const isToday = dateStr === localDateStr(today);

    // Dnevne sume oduzimanja
    const daySpent = {tc:0,rud:0,cd:0,cc:0,tl:0,fl:0,oc:0,od:0};
    dayOtpreme.forEach(o => FIELDS.forEach(f => daySpent[f] += (o[f]||0)));
    const dayTotal = FIELDS.reduce((s,f) => s + daySpent[f], 0);

    // Stanje na poÄetku dana
    const balAtStart = getBalanceAtDate(dateStr);
    const startTotal = FIELDS.reduce((s,f) => s + balAtStart[f], 0);

    // PrikaÅ¾i dan header uvijek (zadnjih 10 dana)
    html += `<div style="margin-top:${hasAny?'20':'0'}px;padding:12px 16px;background:var(--surface);border:1px solid var(--border);border-radius:8px 8px 0 0;display:flex;align-items:center;gap:14px;flex-wrap:wrap">
      <span style="font-family:Syne,sans-serif;font-weight:800;font-size:16px;color:${isToday?'var(--accent)':'var(--text)'}">${label}${isToday?' (danas)':''}</span>
      <span style="font-size:12px;color:var(--muted)">Stanje: <strong style="color:var(--green)">${startTotal.toFixed(2)} mÂ³</strong></span>
      <span style="font-size:12px;color:var(--muted)">Oduzeto: <strong style="color:${dayTotal>0?'var(--red)':'var(--muted)'}">${dayTotal>0?'-':''}${dayTotal.toFixed(2)} mÂ³</strong></span>
      <span style="font-size:12px;color:var(--muted)">${dayOtpreme.length} otprema</span>`;

    // Prikaz po sortimentima
    const activeFields = FIELDS.filter(f => daySpent[f] > 0);
    if (activeFields.length) {
      html += `<div style="display:flex;gap:10px;flex-wrap:wrap;margin-left:auto">`;
      activeFields.forEach(f => {
        html += `<span style="font-size:11px;background:var(--surface2);border:1px solid var(--border);border-radius:4px;padding:2px 8px;color:var(--red)">${FL[f]}: -${daySpent[f].toFixed(2)}</span>`;
      });
      html += `</div>`;
    }
    html += `</div>`;

    if (dayOtpreme.length === 0) {
      html += `<div style="padding:14px 16px;background:var(--surface2);border:1px solid var(--border);border-top:none;border-radius:0 0 8px 8px;color:var(--muted);font-size:13px;text-align:center">Nema otprema</div>`;
    } else {
      html += `<div style="border:1px solid var(--border);border-top:none;border-radius:0 0 8px 8px;overflow:hidden">`;
      dayOtpreme.forEach(o => {
        const disp   = dispozicije.find(d=>d.id===o.disp_id);
        const vals   = FIELDS.filter(f=>o[f]>0)
          .map(f=>`<div class="val-item"><div class="vl">${FL[f]}</div><div class="vv">${o[f]} mÂ³</div></div>`).join('');
        const srcBadge = o.source==='sheet'
          ? '<span class="badge blue">ğŸ“Š Sheet</span>'
          : '<span class="badge" style="color:var(--muted)">âœ‹ RuÄno</span>';
        const unmatch = o.unmatched ? '<span class="badge red">âš  Neuskl.</span>' : '';
        html += `<div class="otprema-card" style="border-radius:0;border:none;border-bottom:1px solid var(--border);margin-bottom:0">
          <div style="min-width:140px">
            <div style="font-family:Syne,sans-serif;font-weight:700;font-size:15px;color:var(--text);margin-bottom:3px">${o.kupac}</div>
            <div>${srcBadge}${unmatch}</div>
            ${disp ? `<div class="badge">${disp.broj}</div>` : ''}
            ${o.broj ? `<div class="badge green">${o.broj}</div>` : ''}
          </div>
          <div style="display:flex;gap:14px;flex-wrap:wrap;flex:1">${vals||'<span style="color:var(--muted);font-size:13px">nema koliÄina</span>'}</div>
          <button class="btn btn-danger" style="padding:6px 12px;font-size:12px" onclick="deleteOtp('${o.id}')">ğŸ—‘</button>
        </div>`;
      });
      html += `</div>`;
    }
    hasAny = true;
  });

  if (!html) {
    list.innerHTML = `<div class="empty-state"><div class="big">ğŸ“­</div><p>Nema otprema</p></div>`;
    return;
  }
  list.innerHTML = html;
}

async function deleteOtp(id) {
  if (!confirm('Storni ovu otpremu? Dispozicija Ä‡e biti vraÄ‡ena.')) return;
  await fbDelOtp(id);
  showToast('Otprema stornirana','success');
}

async function deleteAllOtp() {
  const search     = (document.getElementById('hSearch')?.value||'').toLowerCase();
  const onlySheet  = document.getElementById('hOnlySheet')?.checked;
  const onlyManual = document.getElementById('hOnlyManual')?.checked;
  const filtered = otpreme.filter(o => {
    if (onlySheet  && o.source!=='sheet') return false;
    if (onlyManual && o.source==='sheet') return false;
    return o.kupac.toLowerCase().includes(search) ||
           (o.broj||'').toLowerCase().includes(search) ||
           (o.datum||'').includes(search);
  });
  if (!filtered.length) { showToast('Nema stavki za brisanje', 'error'); return; }
  if (!confirm(`Obrisati svih ${filtered.length} otprema? Dispozicije Ä‡e biti vraÄ‡ene.`)) return;
  await Promise.all(filtered.map(o => fbDelOtp(o.id)));
  showToast(`Obrisano ${filtered.length} otprema`, 'success');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GOOGLE SHEETS SYNC  â€“ odabir datuma â†’ pametno rasporeÄ‘ivanje
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function syncSheet() {
  if (!fs || !db) { showToast('Firebase nije spreman, saÄekajte...', 'error'); return; }

  const today = new Date(); today.setHours(0,0,0,0);
  const todayStr = localDateStr(today);

  const btn     = document.getElementById('syncBtn');
  const spinner = document.getElementById('syncSpinner');
  btn.classList.add('loading');
  spinner.style.display = 'inline-block';
  document.getElementById('syncStatus').textContent = 'UÄitavam...';

  try {
    const url  = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(SHEET_NAME)}&headers=1`;
    const res  = await fetch(url);
    const text = await res.text();
    const json = JSON.parse(text.slice(text.indexOf('{'), text.lastIndexOf('}')+1));
    const rows = json.table.rows;
    const cols = json.table.cols;

    const colIdx = {};
    cols.forEach((c,i) => { if(c.label) colIdx[c.label.trim().toUpperCase()] = i; });

    const cv = (row, lbl) => {
      const i = colIdx[lbl];
      if (i === undefined || !row.c[i] || row.c[i].v === null) return 0;
      const v = row.c[i].v;
      return typeof v === 'number' ? v : (parseFloat(String(v).replace(',','.')) || 0);
    };
    const cs = (row, lbl) => {
      const i = colIdx[lbl];
      if (i === undefined || !row.c[i]) return '';
      return String(row.c[i].v || '').trim();
    };
    const getDate = row => {
      const i = colIdx['DATUM'];
      if (i === undefined || !row.c[i]) return '';
      const cell = row.c[i];
      if (cell.v && typeof cell.v === 'string' && cell.v.startsWith('Date(')) {
        const m = cell.v.match(/Date\((\d+),(\d+),(\d+)\)/);
        if (m) return `${m[1]}-${String(parseInt(m[2])+1).padStart(2,'0')}-${String(m[3]).padStart(2,'0')}`;
      }
      if (cell.f) {
        const p = cell.f.split(/[.\-\/]/).map(x => x.trim());
        if (p.length === 3 && p[2].length === 4)
          return `${p[2]}-${p[1].padStart(2,'0')}-${p[0].padStart(2,'0')}`;
      }
      return cell.f || String(cell.v || '');
    };

    // Collect distinct dates < today from sheet
    // Build count map (include today)
    const dateCountMap = {};
    for (const row of rows) {
      const d = getDate(row);
      if (!d || d > todayStr) continue;
      dateCountMap[d] = (dateCountMap[d] || 0) + 1;
    }

    // Cache helpers for doSync()
    window._syncData = { rows, todayStr, cv, cs, getDate };

    // Always show last 5 days: today + 4 back
    const last5 = [];
    for (let i = 0; i < 5; i++) {
      const d = new Date(today.getTime() - i * 86400000);
      last5.push(localDateStr(d));
    }

    const list = document.getElementById('syncDateList');
    list.innerHTML = last5.map(d => {
      const [y, m, day] = d.split('-');
      const label = `${day}.${m}.${y}`;
      const count = dateCountMap[d] || 0;
      const isToday = d === todayStr;
      const alreadyDone = otpreme.some(o => o.source === 'sheet' && o.datum === d);
      return `<label style="display:flex;align-items:center;gap:12px;padding:11px 14px;background:var(--surface2);border-radius:8px;cursor:pointer;border:1px solid var(--border)">
        <input type="checkbox" value="${d}" style="width:16px;height:16px;accent-color:var(--accent);flex-shrink:0">
        <span style="font-weight:700;font-size:15px">${label}${isToday ? ' <em style="font-size:11px;font-weight:400;color:var(--accent)">(danas)</em>' : ''}</span>
        <span style="font-size:12px;color:var(--muted)">${count} stavki</span>
        ${alreadyDone ? '<span style="margin-left:auto;font-size:11px;color:#4caf50;font-weight:600">âœ“ uvezeno</span>' : ''}
        ${count === 0 ? '<span style="margin-left:auto;font-size:11px;color:var(--muted)">nema u sheet-u</span>' : ''}
      </label>`;
    }).join('');

    // Postavi "Danas" opciju
    const todayAlreadyDone = otpreme.some(o => o.source === 'sheet' && o.datum === todayStr);
    const todayCount = dateCountMap[todayStr] || 0;
    const [ty, tm, tday] = todayStr.split('-');
    document.getElementById('syncTodayDate').textContent = `${tday}.${tm}.${ty}`;
    document.getElementById('syncTodayCheck').checked = false;
    const todayStatus = document.getElementById('syncTodayStatus');
    if (todayAlreadyDone) {
      todayStatus.textContent = 'âœ“ uvezeno';
      todayStatus.style.color = '#4caf50';
    } else if (todayCount > 0) {
      todayStatus.textContent = `${todayCount} stavki`;
      todayStatus.style.color = 'var(--muted)';
    } else {
      todayStatus.textContent = 'nema u sheet-u';
      todayStatus.style.color = 'var(--muted)';
    }

    // Clear custom input
    document.getElementById('syncCustomDate').value = '';

    document.getElementById('syncModal').classList.add('open');

  } catch(e) {
    console.error(e);
    showToast('âŒ GreÅ¡ka pri uÄitavanju Sheet-a: ' + e.message, 'error');
    document.getElementById('syncStatus').textContent = 'GreÅ¡ka!';
  }

  btn.classList.remove('loading');
  spinner.style.display = 'none';
}

function closeSyncModal() {
  document.getElementById('syncModal').classList.remove('open');
}

async function doSync() {
  const sd = window._syncData;
  if (!sd) return;
  const { rows, todayStr, cv, cs, getDate } = sd;

  const checked = [...document.querySelectorAll('#syncDateList input[type=checkbox]:checked')]
                    .map(cb => cb.value);
  if (document.getElementById('syncTodayCheck')?.checked) {
    checked.push(todayStr);
  }
  const customRaw = document.getElementById('syncCustomDate').value.trim();
  if (customRaw) {
    const cm = customRaw.match(/^(\d{2})\.(\d{2})\.(\d{4})$/);
    if (cm) {
      const customISO = `${cm[3]}-${cm[2]}-${cm[1]}`;
      if (customISO <= todayStr) {
        checked.push(customISO);
      } else {
        showToast('Datum ne moÅ¾e biti u buduÄ‡nosti!', 'error');
        return;
      }
    } else {
      showToast('Unesite datum u formatu dd.mm.yyyy', 'error');
      return;
    }
  }
  const selectedDates = [...new Set(checked)];
  if (!selectedDates.length) { showToast('Odaberi barem jedan datum!', 'error'); return; }

  closeSyncModal();

  const btn     = document.getElementById('syncBtn');
  const spinner = document.getElementById('syncSpinner');
  btn.classList.add('loading');
  spinner.style.display = 'inline-block';
  document.getElementById('syncStatus').textContent = 'Sinkroniziram...';

  try {
    const existingKeys     = new Set(otpreme.filter(o => o.sheet_key).map(o => o.sheet_key));
    const existingBaseKeys = new Set([...existingKeys].map(k => k.replace(/_d[A-Za-z0-9]+$/, '')));

    let newCount  = 0;
    let batchDocs = [];

    for (const row of rows) {
      const kupacRaw = cs(row, 'KUPAC');
      if (!kupacRaw) continue;

      const datum = getDate(row);
      if (!datum) continue;

      // Only import selected dates
      if (!selectedDates.includes(datum)) continue;

      const qtyRow = {
        tc:  cv(row, 'TRUPCI ÄŒ'),
        rud: cv(row, 'RD'),
        cd:  cv(row, 'CEL.DUGA'),
        cc:  cv(row, 'CEL.CIJEPANA'),
        tl:  cv(row, 'TRUPCI L'),
        fl:  cv(row, 'F/L L'),
        oc:  cv(row, 'OGR.CIJEPANI'),
        od:  cv(row, 'OGR.DUGI'),
      };

      const totalQty = FIELDS.reduce((s,f) => s + qtyRow[f], 0);
      if (totalQty === 0) continue;

      const rowKey = `sheet_${datum}_${kupacRaw}_${FIELDS.map(f=>qtyRow[f]).join('_')}`;
      if (existingKeys.has(rowKey) || existingBaseKeys.has(rowKey)) continue;
      existingKeys.add(rowKey);
      existingBaseKeys.add(rowKey);

      const ku = kupacRaw.toUpperCase().trim();
      const kandidati = dispozicije
        .filter(d => {
          const dk = d.kupac.toUpperCase().trim();
          return dk === ku || dk.includes(ku) || ku.includes(dk);
        })
        .filter(d => !d.datum || d.datum <= datum)
        .sort((a,b) => (a.datum||'').localeCompare(b.datum||''));

      if (kandidati.length === 0) {
        const id = 'sh_' + Date.now() + '_' + Math.random().toString(36).slice(2,5);
        batchDocs.push({ id, data: {
          id, sheet_key: rowKey, source: 'sheet',
          kupac: kupacRaw, disp_id: null, unmatched: true,
          datum, broj: cs(row, 'OTPREMAÄŒ') || '', ...qtyRow
        }});
        newCount++;
        continue;
      }

      const batchSpent = {};
      const splits     = {};

      for (const field of FIELDS) {
        let remaining = qtyRow[field];
        if (remaining <= 0) continue;
        for (const disp of kandidati) {
          if (remaining <= 0) break;
          const bal          = getBalance(disp);
          const alreadySpent = (batchSpent[disp.id] || {})[field] || 0;
          const available    = Math.max(0, bal[field] - alreadySpent);
          if (available <= 0) continue;
          const take = Math.min(remaining, available);
          if (!splits[disp.id])     splits[disp.id]     = {tc:0,rud:0,cd:0,cc:0,tl:0,fl:0,oc:0,od:0};
          if (!batchSpent[disp.id]) batchSpent[disp.id] = {tc:0,rud:0,cd:0,cc:0,tl:0,fl:0,oc:0,od:0};
          splits[disp.id][field]     += take;
          batchSpent[disp.id][field] += take;
          remaining -= take;
        }
        if (remaining > 0) {
          const lastDisp = kandidati[kandidati.length - 1];
          if (!splits[lastDisp.id]) splits[lastDisp.id] = {tc:0,rud:0,cd:0,cc:0,tl:0,fl:0,oc:0,od:0};
          splits[lastDisp.id][field] += remaining;
        }
      }

      const dispIds = Object.keys(splits);
      for (const disp_id of dispIds) {
        const fieldQtys  = splits[disp_id];
        const fieldTotal = FIELDS.reduce((s,f) => s + fieldQtys[f], 0);
        if (fieldTotal <= 0) continue;
        const id = 'sh_' + Date.now() + '_' + Math.random().toString(36).slice(2,6);
        batchDocs.push({ id, data: {
          id,
          sheet_key: dispIds.length === 1 ? rowKey : `${rowKey}_${disp_id}`,
          source: 'sheet', kupac: kupacRaw, disp_id,
          unmatched: false, datum, broj: cs(row, 'OTPREMAÄŒ') || '', ...fieldQtys
        }});
        newCount++;
      }
    }

    for (let i = 0; i < batchDocs.length; i += 490) {
      const batch = fs.writeBatch(db);
      batchDocs.slice(i, i + 490).forEach(({ id, data }) => {
        batch.set(fs.doc(db, 'otpreme', id), data);
      });
      await batch.commit();
    }

    const now = new Date().toISOString();
    await fbSetMeta('sync', { lastSync: now });
    updateSyncStatus(now);
    const datesLabel = selectedDates
      .map(d => { const [y,m,dd]=d.split('-'); return `${dd}.${m}.${y}`; }).join(', ');
    showToast(`âœ… Sinkronizirano: ${newCount} novih zapisa za ${datesLabel}`, 'success');

  } catch(e) {
    console.error(e);
    showToast('âŒ GreÅ¡ka: ' + e.message, 'error');
    document.getElementById('syncStatus').textContent = 'GreÅ¡ka!';
  }

  btn.classList.remove('loading');
  spinner.style.display = 'none';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EXPORT CSV â€“ helper
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateSyncStatus(iso) {
  if (!iso) return;
  const d = new Date(iso);
  document.getElementById('syncStatus').textContent =
    `Sinkr: ${d.toLocaleDateString('bs-BA')} ${d.toLocaleTimeString('bs-BA',{hour:'2-digit',minute:'2-digit'})}`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EXPORT CSV
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportCSV() {
  const rows = [['KUPAC','BROJ','DATUM','UGOVOR',
    'BAL_TC','BAL_RUD','BAL_CD','BAL_CC','BAL_TL','BAL_FL','BAL_OC','BAL_OD',
    'ORIG_TC','ORIG_RUD','ORIG_CD','ORIG_CC','ORIG_TL','ORIG_FL','ORIG_OC','ORIG_OD']];
  dispozicije.forEach(d => {
    const bal = getBalance(d);
    rows.push([d.kupac,d.broj,d.datum,d.ugovor,
      ...FIELDS.map(f=>bal[f].toFixed(2)),
      ...FIELDS.map(f=>(d[f]||0).toFixed(2))]);
  });
  const csv = rows.map(r=>r.join(';')).join('\n');
  const a   = document.createElement('a');
  a.href    = URL.createObjectURL(new Blob(['\uFEFF'+csv],{type:'text/csv;charset=utf-8;'}));
  a.download= `dispozicije_${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleDesktopView(isDesktop) {
  document.body.classList.toggle('mob-cards-mode', !isDesktop);
  const vp = document.querySelector('meta[name="viewport"]');
  vp.content = isDesktop
    ? 'width=1200, user-scalable=yes'
    : 'width=device-width, initial-scale=1.0, user-scalable=yes';
}

function switchTab(t) {
  const names = ['pregled','nova','otprema','historija'];
  document.querySelectorAll('.tab').forEach((el,i)   => el.classList.toggle('active', names[i]===t));
  document.querySelectorAll('.panel').forEach((el,i) => el.classList.toggle('active', names[i]===t));
  document.querySelectorAll('.mnav-btn[data-tab]').forEach(btn => btn.classList.toggle('active', btn.dataset.tab===t));
  if(t==='pregled')   renderPregled();
  if(t==='nova')      renderNova();
  if(t==='otprema')   renderOtprema();
  if(t==='historija') renderHistorija();
}

function renderAll() {
  const active = document.querySelector('.tab.active');
  if (!active) return;
  const idx = [...document.querySelectorAll('.tab')].indexOf(active);
  const names = ['pregled','nova','otprema','historija'];
  if (names[idx]==='pregled')   renderPregled();
  if (names[idx]==='historija') renderHistorija();
}

let toastTimer;
function showToast(msg, type='success') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className   = 'toast ' + type + ' show';
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 4000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BOOT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('firebaseReady', initFirebase);
// also try immediately in case event already fired
if (window._firebaseReady) initFirebase();
</script>
</body>
</html>
